#!/bin/sh

set -e
cd "${0%/*}/.."
readonly URL='https://www.unicode.org/Public/UCD/latest/ucd/DerivedCoreProperties.txt'
trap 'rm -f xx00 xx01' EXIT
mkdir -p src/gen
exec >src/gen/xid.h

cat <<EOF
/* This file is autogenerated by gen/xid; DO NOT EDIT. */

/* TODO: Change tables to const from constexpr when Clangd gets better */

#ifndef ANDY_GEN_XID_H
#define ANDY_GEN_XID_H

#include "../utf8.h"

EOF

{
	curl -s "$URL"
	cat <<-EOF
	2032..2034    ; XID_Continue # Po   [3] PRIME..TRIPLE PRIME
	2057          ; XID_Continue # Po       QUADRUPLE PRIME
	EOF
} | awk '
BEGIN { FS = "\\s*;\\s*" }

$2 ~ /^XID_Continue/ && !x {
	print ""
	x = 1
}

$2 ~ /^XID_(Start|Continue)/ {
	n = split($1, a, /\.\./)
	for (i = 1; i <= n; i++) {
		while (length(a[i]) < 5)
			a[i] = "0" a[i]
	}
	printf "{0x%s, 0x%s},\n", a[1], a[n]
}
' | csplit -s - '/^$/'

for f in xx00 xx01
do
	case $f in
	xx00) name=start ;;
	xx01) name=cont  ;;
	esac

	grep . $f | sort | paste -d' ' - - - | sed "
		1istatic const rune xid_${name}_tbl[][2] = {
		s/^/\t/
		\$a};
	"
	test $f = xx00 && echo
done

cat <<EOF

#endif /* !ANDY_GEN_XID_H */
EOF
