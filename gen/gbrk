#!/bin/sh

set -e
cd "${0%/*}/.."
readonly URL='https://www.unicode.org/Public/UCD/latest/ucd/auxiliary/GraphemeBreakProperty.txt'
mkdir -p src/gen

tmp=$(mktemp)
trap "rm -f $tmp" EXIT
wget -q "$URL" -O $tmp

exec >src/gen/gbrk.h

cat <<EOF
/* This file is autogenerated by gen/gbrk; DO NOT EDIT. */

/* TODO: Change tables to constexpr from const when Clangd gets better */

#ifndef ANDY_GEN_GBRK_H
#define ANDY_GEN_GBRK_H

#include "../utf8.h"

typedef enum {
	GBP_OTHER = 0,
	GBP_CTRL  = 1 <<  0, /* Control */
	GBP_EXT   = 1 <<  1, /* Extend */
	GBP_L     = 1 <<  2, /* L */
	GBP_LV    = 1 <<  3, /* LV */
	GBP_LVT   = 1 <<  4, /* LVT */
	GBP_PREP  = 1 <<  5, /* Prepend */
	GBP_RI    = 1 <<  6, /* Regional_Indicator */
	GBP_SM    = 1 <<  7, /* SpacingMark */
	GBP_T     = 1 <<  8, /* T */
	GBP_V     = 1 <<  9, /* V */
	GBP_ZWJ   = 1 << 10, /* ZWJ */
} rgbrk_prop;

static const struct {
	rune lo, hi;
	rgbrk_prop prop;
} rgbrk_prop_tbl[] = {
EOF

awk '
BEGIN {
	FS = "\\s+;?\\s*"
	map["Control"] = "CTRL"
	map["Extend"] = "EXT"
	map["L"] = "L"
	map["LV"] = "LV"
	map["LVT"] = "LVT"
	map["Prepend"] = "PREP"
	map["Regional_Indicator"] = "RI"
	map["SpacingMark"] = "SM"
	map["T"] = "T"
	map["V"] = "V"
	map["ZWJ"] = "ZWJ"
}

map[$2] {
	n = split($1, a, /\.\./)
	for (i = 1; i <= n; i++) {
		while (length(a[i]) < 5)
			a[i] = "0" a[i]
	}
	printf "\t{0x%s, 0x%s, %8s},\n", a[1], a[n], "GBP_" map[$2]
}
' $tmp | sort

cat <<EOF
};

#endif /* !ANDY_GEN_GBRK_H */
EOF
